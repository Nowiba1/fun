<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chaos Arena Slap-Fest</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Arial Black', sans-serif; background: #222; color: white; }
        canvas { display: block; }
        
        /* UI Overlays */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; pointer-events: none; }
        .menu-card { background: rgba(0,0,0,0.8); padding: 30px; border-radius: 15px; border: 4px solid #ff0055; pointer-events: auto; text-align: center; width: 400px; }
        
        button { background: #ff0055; color: white; border: none; padding: 15px 30px; font-size: 1.2rem; cursor: pointer; border-radius: 8px; margin: 10px; transition: transform 0.1s; }
        button:hover { transform: scale(1.05); background: #ff4488; }
        input { padding: 10px; width: 80%; margin: 10px; border-radius: 5px; border: none; }
        
        #hud { position: absolute; top: 20px; left: 20px; pointer-events: none; display: none; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="hud">
        <h2 id="status">ALIVE: 4</h2>
    </div>

    <div id="ui-layer">
        <div id="main-menu" class="menu-card">
            <h1>SLAP-FEST 3D</h1>
            <button onclick="startGame(false)">SOLO (vs BOTS)</button>
            <button onclick="showMultiplayer()">MULTIPLAYER</button>
        </div>

        <div id="multi-menu" class="menu-card hidden">
            <h3>MULTIPLAYER (WebRTC)</h3>
            <button onclick="initHost()">CREATE ROOM</button>
            <p>OR</p>
            <input type="text" id="join-code" placeholder="Paste Code Here">
            <button onclick="initJoin()">JOIN ROOM</button>
            <br>
            <button onclick="showMainMenu()" style="background:#555">BACK</button>
        </div>

        <div id="connection-screen" class="menu-card hidden">
            <h3 id="conn-title">Your Room Code:</h3>
            <textarea id="copy-code" style="width:100%; height:100px;" readonly></textarea>
            <p>Send this to your friend, then paste their response back.</p>
            <input type="text" id="pasted-response" placeholder="Paste response here">
            <button onclick="processResponse()">CONNECT</button>
        </div>
    </div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
    </script>

    <script type="module">
        import * as THREE from 'three';

        // --- GAME CONFIG ---
        const CONFIG = {
            arenaSize: 20,
            gravity: -0.05,
            slapForce: 0.8,
            friction: 0.92,
            colors: [0xff0055, 0x00ffaa, 0x00aaff, 0xffaa00]
        };

        let scene, camera, renderer, clock;
        let players = [];
        let isGameRunning = false;

        // --- CORE CLASSES ---
        class Player {
            constructor(id, color, isBot = false) {
                this.id = id;
                this.isBot = isBot;
                this.velocity = new THREE.Vector3();
                this.isGrounded = true;
                this.isDead = false;

                // Mesh: Simple box body + big hand spheres
                const group = new THREE.Group();
                const body = new THREE.Mesh(new THREE.BoxGeometry(1, 1.5, 1), new THREE.MeshPhongMaterial({ color }));
                group.add(body);
                
                this.hand = new THREE.Mesh(new THREE.SphereGeometry(0.4), new THREE.MeshPhongMaterial({ color: 0xffffff }));
                this.hand.position.set(0.8, 0, 0.5);
                group.add(this.hand);

                this.mesh = group;
                this.mesh.position.y = 1;
                this.mesh.position.x = (Math.random() - 0.5) * 10;
                this.mesh.position.z = (Math.random() - 0.5) * 10;
                scene.add(this.mesh);
            }

            update(input) {
                if (this.isDead) return;

                // Movement Logic
                if (input.left) this.velocity.x -= 0.02;
                if (input.right) this.velocity.x += 0.02;
                if (input.up) this.velocity.z -= 0.02;
                if (input.down) this.velocity.z += 0.02;

                // Apply Physics
                this.mesh.position.add(this.velocity);
                this.velocity.multiplyScalar(CONFIG.friction);
                
                // Gravity
                if (this.mesh.position.y > 0.75) {
                    this.velocity.y += CONFIG.gravity;
                } else {
                    this.velocity.y = 0;
                    this.mesh.position.y = 0.75;
                }

                // Check Fall
                if (this.mesh.position.y < -5) {
                    this.die();
                }
            }

            die() {
                this.isDead = true;
                this.mesh.visible = false;
            }
        }

        // --- INITIALIZATION ---
        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x111111);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 15, 15);
            camera.lookAt(0, 0, 0);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            const light = new THREE.DirectionalLight(0xffffff, 1);
            light.position.set(5, 10, 7);
            scene.add(light, new THREE.AmbientLight(0x404040));

            // Arena
            const floor = new THREE.Mesh(
                new THREE.BoxGeometry(CONFIG.arenaSize, 1, CONFIG.arenaSize),
                new THREE.MeshPhongMaterial({ color: 0x333333 })
            );
            floor.position.y = -0.5;
            scene.add(floor);

            clock = new THREE.Clock();
            animate();
        }

        // --- GAME LOOP ---
        const keys = {};
        window.onkeydown = (e) => keys[e.code] = true;
        window.onkeyup = (e) => keys[e.code] = false;

        function animate() {
            requestAnimationFrame(animate);
            
            if (isGameRunning) {
                const p1Input = {
                    left: keys['KeyA'] || keys['ArrowLeft'],
                    right: keys['KeyD'] || keys['ArrowRight'],
                    up: keys['KeyW'] || keys['ArrowUp'],
                    down: keys['KeyS'] || keys['ArrowDown']
                };

                players.forEach(p => {
                    if (p.id === 'local') p.update(p1Input);
                    else if (p.isBot) updateAI(p);
                });
            }

            renderer.render(scene, camera);
        }

        function updateAI(bot) {
            // Simple AI: Move toward center if too far, otherwise move randomly
            const dist = bot.mesh.position.length();
            const input = { left: false, right: false, up: false, down: false };
            
            if (dist > 5) {
                if (bot.mesh.position.x > 0) input.left = true; else input.right = true;
                if (bot.mesh.position.z > 0) input.up = true; else input.down = true;
            } else {
                if (Math.random() > 0.95) input.right = Math.random() > 0.5;
            }
            bot.update(input);
        }

        // --- UI & STATE ---
        window.startGame = (multi) => {
            document.getElementById('ui-layer').classList.add('hidden');
            document.getElementById('hud').style.display = 'block';
            
            players.push(new Player('local', CONFIG.colors[0]));
            players.push(new Player('bot1', CONFIG.colors[1], true));
            players.push(new Player('bot2', CONFIG.colors[2], true));
            
            isGameRunning = true;
        };

        window.showMultiplayer = () => {
            document.getElementById('main-menu').classList.add('hidden');
            document.getElementById('multi-menu').classList.remove('hidden');
        };

        window.showMainMenu = () => {
            document.getElementById('multi-menu').classList.add('hidden');
            document.getElementById('main-menu').classList.remove('hidden');
        };

        init();
    </script>
</body>
</html>
